@{
    Layout = "~/Views/Shared/_AdminNav.cshtml";
}
@model List<ServiceInformation>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Research Progress Management</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="~/css/admin/tracking.css" asp-append-version="true" />

</head>
<body data-color-scheme="light">
    <div class="main-container">

        <div class="page-header">
            <h1 class="page-title">
                <i class="fas fa-clipboard-list"></i>
                Research Progress Management
            </h1>
            <p class="page-subtitle">Monitor and update student research submissions across all departments</p>
        </div>

        <!-- Statistics Row -->
        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-number" id="totalStudents">6</div>
                <div class="stat-label">Total Submissions</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="processingCount">3</div>
                <div class="stat-label">Processing</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="completedCount">2</div>
                <div class="stat-label">Complete</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="failedCount">1</div>
                <div class="stat-label">Failed</div>
            </div>
        </div>

        <!-- Collapsible Filter Section -->
        <div class="filter-section collapsed" id="filterSection">
            <div class="filter-toggle" id="filterToggle">
                <span class="filter-toggle-text">
                    <i class="fas fa-filter"></i>
                    Filter & Search
                </span>
                <i class="fas fa-chevron-down filter-toggle-icon"></i>
            </div>
            <div class="filter-content" id="filterContent">
                <div class="search-container">
                    <input type="text" class="search-input" id="searchInput" placeholder="Search by name, student number, or service..." />
                    <i class="fas fa-search search-icon"></i>
                </div>

                <div class="filters-grid">
                    <div class="filter-group">
                        <label class="filter-label">Department:</label>
                        <div class="filter-tabs" id="departmentTabs">
                            <!-- Tabs will be populated by JavaScript -->
                        </div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Service:</label>
                        <div class="filter-tabs" id="serviceTabs">
                            <!-- Tabs will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Students Table Container -->
        <div class="table-wrapper" id="studentsTableContainer">
            <!-- Table will be populated by JavaScript -->
        </div>

        <!-- Service Steps Modal -->
        <div id="serviceStepsModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modalTitle">Service Steps</h3>
                    <span class="close" onclick="closeServiceStepsModal()">&times;</span>
                </div>
                <div class="modal-body" id="modalBody">
                    <!-- Service steps will be populated here -->
                </div>
            </div>
        </div>

    </div>

    <script>

        const serviceInfoFromDb = @Json.Serialize(Model);
        function getStepStatus(progressValue) {
            switch (progressValue) {
                case 1: return "current";
                case 2: return "complete";
                case 3: return "revision";
                case 0:
                default:
                    return "pending";
            }
        }

        function transformDbData(si) {

            const prog = si.serviceProgress;
            const stepStatuses = [
                getStepStatus(prog.progress1),
                getStepStatus(prog.progress2),
                getStepStatus(prog.progress3),
                getStepStatus(prog.progress4)
            ];

            let status = "processing";
            if (stepStatuses.includes("revision")) {
                status = "failed";
            } else if (stepStatuses.every(s => s === "complete")) {
                status = "complete";
            }

            let currentStep = stepStatuses.findIndex(s => s === "current") + 1;
            if (currentStep === 0) {
                currentStep = stepStatuses.findIndex(s => s === "pending") + 1;
            }
            if (currentStep === 0 && !stepStatuses.includes("revision")) {
                currentStep = stepStatuses.length;
            }

            const serviceKey = si.serviceType.toLowerCase().replace(/ /g, '-');
                const allReceivedFiles = [
            ...(prog.progress1files || []),
            ...(prog.progress2files || []),
            ...(prog.progress3files || []),
            ...(prog.progress4files || [])
        ];
            return {
                "id": si.serviceId, 
                "name": si.author, 
                "studentNumber": si.studentNumber,
                "department": si.subject, 
                "course": "N/A",     
                "service": serviceKey,
                "serviceName": si.serviceType,
                "status": status,
                "currentStep": currentStep,
                "totalSteps": 4, 
                "runCount": 1,  
                "dateSubmitted": prog.appliedDate,
                "lastUpdated": prog.appliedDate, 
                "receivedFiles": allReceivedFiles,
                "sendFiles": 0, 
                "remarks": "", 
                "stepStatuses": stepStatuses
            };
        }

        const studentsFromDb = serviceInfoFromDb.map(transformDbData);
        const departmentsFromDb = [...new Set(studentsFromDb.map(s => s.department))];
        const servicesFromDb = [...new Map(studentsFromDb.map(s => [s.service, { key: s.service, name: s.serviceName }])).values()];

        const applicationData = {
            "students": studentsFromDb,
            "departments": departmentsFromDb,
            "services": servicesFromDb,
            "generalStatusTypes": [
                { "key": "processing", "name": "Processing", "color": "#3b82f6" },
                { "key": "complete", "name": "Complete", "color": "#10b981" },
                { "key": "failed", "name": "Failed", "color": "#ef4444" }
            ],
            "stepStatusTypes": [
                { "key": "pending", "name": "PENDING", "color": "#94a3b8" },
                { "key": "current", "name": "CURRENT", "color": "#3b82f6" },
                { "key": "complete", "name": "COMPLETE", "color": "#10b981" },
                { "key": "revision", "name": "REVISION", "color": "#fd7e14" }
            ],
            "serviceSteps": {
                "originality-check": {
  
                },
                "instrument-validation": {
  
                },
                "language-editing": {
  
                },
                "data-analysis": {
  
                },
                "student-research-clearance": {
  
                },
                "ethics-review": {
  
                }
            }
        };

        let currentDepartment = 'all';
        let currentService = 'all';
        let expandedRow = null;
        let filteredStudents = [...applicationData.students];

        document.addEventListener('DOMContentLoaded', function () {
            initializeApp();
        });

        function initializeApp() {
            renderTable();
            setupEventListeners();
            updateStatistics();

            const filterSection = document.getElementById('filterSection');
            if (filterSection) {
                filterSection.classList.add('collapsed');
            }
        }

        function setupEventListeners() {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', handleSearch);
            }
            const filterToggle = document.getElementById('filterToggle');
            if (filterToggle) {
                filterToggle.addEventListener('click', toggleFilterSection);
            }

            setupFilterTabs();
        }

        function setupFilterTabs() {
            const departmentContainer = document.getElementById('departmentTabs');
            if (departmentContainer) {
                departmentContainer.innerHTML = '';

                const allDeptTab = createFilterTab('All Departments', 'all', currentDepartment === 'all');
                allDeptTab.onclick = () => filterByDepartment('all');
                departmentContainer.appendChild(allDeptTab);


                applicationData.departments.forEach(dept => {
                    const tab = createFilterTab(dept, dept, currentDepartment === dept);
                    tab.onclick = () => filterByDepartment(dept);
                    departmentContainer.appendChild(tab);
                });
            }

            const serviceContainer = document.getElementById('serviceTabs');
            if (serviceContainer) {
                serviceContainer.innerHTML = '';

                const allServiceTab = createFilterTab('All Services', 'all', currentService === 'all');
                allServiceTab.onclick = () => filterByService('all');
                serviceContainer.appendChild(allServiceTab);

                applicationData.services.forEach(service => {
                    const tab = createFilterTab(service.name, service.key, currentService === service.key);
                    tab.onclick = () => filterByService(service.key);
                    serviceContainer.appendChild(tab);
                });
            }
        }

        function createFilterTab(text, value, isActive) {
            const tab = document.createElement('button');
            tab.className = `filter-tab ${isActive ? 'active' : ''}`;
            tab.textContent = text;
            tab.setAttribute('data-value', value);
            return tab;
        }

        function toggleFilterSection() {
            const filterSection = document.getElementById('filterSection');
            const toggleIcon = document.querySelector('.filter-toggle-icon');

            if (filterSection && toggleIcon) {
                filterSection.classList.toggle('collapsed');
            }
        }

        function handleSearch(event) {
            const searchTerm = event.target.value.toLowerCase().trim();

            if (searchTerm === '') {
                filteredStudents = [...applicationData.students];
            } else {
                filteredStudents = applicationData.students.filter(student => {
                    return student.name.toLowerCase().includes(searchTerm) ||
                        student.studentNumber.toLowerCase().includes(searchTerm) ||
                        student.serviceName.toLowerCase().includes(searchTerm) ||
                        student.department.toLowerCase().includes(searchTerm);
                });
            }

            applyFilters();
        }

        function filterByDepartment(department) {
            currentDepartment = department;

            document.querySelectorAll('#departmentTabs .filter-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.getAttribute('data-value') === department) {
                    tab.classList.add('active');
                }
            });

            applyFilters();
        }

        function filterByService(service) {
            currentService = service;

            document.querySelectorAll('#serviceTabs .filter-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.getAttribute('data-value') === service) {
                    tab.classList.add('active');
                }
            });

            applyFilters();
        }

        function applyFilters() {
            let filtered = [...filteredStudents];

            if (currentDepartment !== 'all') {
                filtered = filtered.filter(student => student.department === currentDepartment);
            }

            if (currentService !== 'all') {
                filtered = filtered.filter(student => student.service === currentService);
            }

            renderTable(filtered);
            updateStatistics(filtered);
        }

        function renderTable(students = applicationData.students) {
            const tableContainer = document.getElementById('studentsTableContainer');
            if (!tableContainer) return;

            const table = `
                <div class="table-container">
                    <div class="table-header">
                        <h3 class="table-title">
                            <i class="fas fa-users"></i>
                            Research Submissions (${students.length})
                        </h3>
                    </div>
                    <table class="students-table">
                        <thead>
                            <tr>
                                <th>Student</th>
                                <th>Department</th>
                                <th>Service</th>
                                <th>Status</th>
                                <th>Progress</th>
                                <th>Last Updated</th>
                                <th>Guide</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${students.map(student => createStudentRow(student)).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            tableContainer.innerHTML = table;
            setupTableEventListeners();
        }

        function createStudentRow(student) {
            const progressPercentage = Math.round((student.currentStep / student.totalSteps) * 100);
            const statusClass = `status-${student.status}`;
            const initials = student.name.split(' ').map(n => n[0]).join('').substring(0, 2);

            return `
                <tr class="student-row" onclick="toggleStudentDetails('${student.id}')" data-student-id="${student.id}">
                    <td>
                        <div class="student-info">
                            <div class="student-avatar">${initials}</div>
                            <div class="student-details">
                                <h4>${student.name}</h4>
                                <p>${student.studentNumber} • ${student.course}</p>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="department-text">${student.department}</span>
                    </td>
                    <td>
                        <span class="service-badge">${student.serviceName}</span>
                    </td>
                    <td>
                        <span class="status-badge ${statusClass}">${student.status}</span>
                    </td>
                    <td>
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div class="progress-fill ${statusClass}" style="width: ${progressPercentage}%"></div>
                            </div>
                            <div class="progress-text">${student.currentStep}/${student.totalSteps} steps</div>
                        </div>
                    </td>
                    <td>${formatDate(student.lastUpdated)}</td>
                    <td>
                        <button class="action-btn info-btn" onclick="event.stopPropagation(); showServiceSteps('${student.service}')" title="View Service Steps">
                            <i class="fas fa-info-circle"></i>
                        </button>
                    </td>
                </tr>
                <tr class="expanded-content hidden" id="expanded-${student.id}">
                    <td colspan="7">
                        ${createExpandedContent(student)}
                    </td>
                </tr>
            `;
        }

        function createExpandedContent(student) {
            return `
                <div class="expanded-inner">
                    <div class="control-section">
                        <div class="section-header">
                            <i class="fas fa-cogs"></i>
                            Progress Control
                        </div>

                        <div class="progress-controls">
                            <div class="control-group">
                                <label class="control-label">General Status:</label>
                                <select class="status-select" onchange="updateGeneralStatus('${student.id}', this.value)">
                                    ${applicationData.generalStatusTypes.map(status =>
                `<option value="${status.key}" ${student.status === status.key ? 'selected' : ''}>
                                            ${status.name}
                                        </option>`
            ).join('')}
                                </select>
                            </div>

                            <div class="control-group">
                                <label class="control-label">Run Count:</label>
                                <div class="run-count-controls">
                                    <button class="run-count-btn" onclick="updateRunCount('${student.id}', -1)">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <span class="run-count-display" id="runCount-${student.id}">${student.runCount}</span>
                                    <button class="run-count-btn" onclick="updateRunCount('${student.id}', 1)">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="step-management">
                            <div class="section-header">
                                <i class="fas fa-list-ol"></i>
                                Step Management
                            </div>

                            <div class="step-indicator">
                                ${student.stepStatuses.map((status, index) =>
                `<div class="step-dot ${status}" title="Step ${index + 1}: ${status.toUpperCase()}">${index + 1}</div>`
            ).join('')}
                            </div>

                            <div class="step-status-controls">
                                ${student.stepStatuses.map((status, index) => `
                                    <div class="step-status-item">
                                        <span class="step-label">Step ${index + 1}:</span>
                                        <select class="step-status-select" onchange="updateStepStatus('${student.id}', ${index}, this.value)">
                                            ${applicationData.stepStatusTypes.map(stepStatus =>
                    `<option value="${stepStatus.key}" ${status === stepStatus.key ? 'selected' : ''}>
                                                    ${stepStatus.name}
                                                </option>`
                ).join('')}
                                        </select>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <div class="control-section">
                        <div class="section-header">
                            <i class="fas fa-folder-open"></i>
                            File Management
                        </div>

                        <div class="file-tabs">
                            <button class="file-tab active" onclick="switchFileTab('${student.id}', 'received')">
                                Received Files <span class="file-count">${student.receivedFiles.length}</span>
                            </button>
                            <button class="file-tab" onclick="switchFileTab('${student.id}', 'send')">
                                Send to Student <span class="file-count">${student.sendFiles}</span>
                            </button>
                        </div>

                        <div class="file-content" id="fileContent-${student.id}">
                            ${createReceivedFilesContent(student)}
                        </div>

                        <div class="section-header" style="margin-top: 1.5rem;">
                            <i class="fas fa-comment-alt"></i>
                            Remarks
                        </div>

                        <textarea class="remarks-textarea" placeholder="Add remarks..." onchange="updateRemarks('${student.id}', this.value)">${student.remarks}</textarea>

                        <div class="action-buttons">
                            <button class="action-btn btn-primary" onclick="saveChanges('${student.id}')">
                                <i class="fas fa-save"></i> Save Changes
                            </button>
                            <button class="action-btn btn-secondary" onclick="toggleStudentDetails('${student.id}')">
                                <i class="fas fa-times"></i> Close
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

                function createReceivedFilesContent(student) {
            // 'student.receivedFiles' is now an array like ["report.pdf", "data.xlsx"]
            return `
                <div class="file-list">
                    ${student.receivedFiles.length > 0 ?
                        student.receivedFiles.map((fileName, index) => `
                            <div class="file-item">
                                <div class="file-icon">
                                    <i class="fas ${getFileIcon(fileName)}"></i>
                                </div>
                                <div class="file-info">
                                    <div class="file-name">${fileName}</div>
                                    
                                </div>
                                <div class="file-actions">
                                    <a href="/uploads/Service_${student.id}/${fileName}" class="file-action-btn btn-download" title="Download ${fileName}" download>
                                        <i class="fas fa-download"></i>
                                    </a>
                                </div>
                            </div>
                        `).join('') :
                        '<p style="text-align: center; color: #6b7280; padding: 2rem;">No files received yet</p>'
                    }
                </div>
            `;
        }

        // BONUS: Add this helper function to your script to get file-specific icons
        function getFileIcon(fileName) {
            const ext = fileName.split('.').pop().toLowerCase();
            switch (ext) {
                case 'pdf': return 'fa-file-pdf';
                case 'doc':
                case 'docx': return 'fa-file-word';
                case 'xls':
                case 'xlsx': return 'fa-file-excel';
                case 'png':
                case 'jpg':
                case 'jpeg':
                case 'gif': return 'fa-file-image';
                case 'zip':
                case 'rar': return 'fa-file-archive';
                default: return 'fa-file-alt'; // Default file icon
            }
        }

        function createSendFilesContent(student) {
            return `
                <div class="drag-drop-area" onclick="document.getElementById('fileInput-${student.id}').click()">
                    <div class="drag-drop-text">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; margin-bottom: 1rem; color: #3b82f6;"></i><br>
                        Click to upload files or drag and drop<br>
                        <small>PDF, DOC, DOCX files up to 10MB</small>
                    </div>
                    <input type="file" id="fileInput-${student.id}" multiple accept=".pdf,.doc,.docx" style="display: none;" onchange="handleFileUpload('${student.id}', this.files)">
                </div>

                <div class="file-list">
                    ${student.sendFiles > 0 ?
                    Array(student.sendFiles).fill().map((_, index) => `
                        <div class="file-item">
                            <div class="file-icon">
                                <i class="fas fa-file-pdf"></i>
                            </div>
                            <div class="file-info">
                                <div class="file-name">Response_${index + 1}.pdf</div>
                                <div class="file-size">1.8 MB</div>
                            </div>
                            <div class="file-actions">
                                <button class="file-action-btn btn-send" title="Send to Student">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                                <button class="file-action-btn btn-delete" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `).join('') :
                    '<p style="text-align: center; color: #6b7280; padding: 1rem;">No files to send</p>'
                }
                </div>
            `;
        }

        function setupTableEventListeners() {

        }

        function toggleStudentDetails(studentId) {
            const expandedRow = document.getElementById(`expanded-${studentId}`);
            const studentRow = document.querySelector(`[data-student-id="${studentId}"]`);

            if (expandedRow && studentRow) {
                const isExpanded = !expandedRow.classList.contains('hidden');

                document.querySelectorAll('.expanded-content').forEach(row => {
                    row.classList.add('hidden');
                });

                document.querySelectorAll('.student-row').forEach(row => {
                    row.classList.remove('expanded');
                });

                if (!isExpanded) {
                    expandedRow.classList.remove('hidden');
                    studentRow.classList.add('expanded');
                    expandedRow = studentId;
                } else {
                    expandedRow = null;
                }
            }
        }

        function switchFileTab(studentId, tabType) {
            const student = applicationData.students.find(s => s.id === studentId);
            if (!student) return;

            // Update tab states
            const tabContainer = document.querySelector(`#expanded-${studentId} .file-tabs`);
            if (tabContainer) {
                tabContainer.querySelectorAll('.file-tab').forEach(tab => {
                    tab.classList.remove('active');
                });

                const activeTab = tabType === 'received' ? tabContainer.firstElementChild : tabContainer.lastElementChild;
                if (activeTab) {
                    activeTab.classList.add('active');
                }
            }

            // Update content
            const contentContainer = document.getElementById(`fileContent-${studentId}`);
            if (contentContainer) {
                if (tabType === 'received') {
                    contentContainer.innerHTML = createReceivedFilesContent(student);
                } else {
                    contentContainer.innerHTML = createSendFilesContent(student);
                }
            }
        }

        function updateGeneralStatus(studentId, newStatus) {
            const student = applicationData.students.find(s => s.id === studentId);
            if (student) {
                student.status = newStatus;
                student.lastUpdated = new Date().toISOString().split('T')[0];

                // Re-render the table to reflect changes
                applyFilters();

                // Re-expand the row if it was expanded
                setTimeout(() => {
                    if (expandedRow === studentId) {
                        toggleStudentDetails(studentId);
                    }
                }, 100);
            }
        }

        function updateRunCount(studentId, delta) {
            const student = applicationData.students.find(s => s.id === studentId);
            if (student) {
                const newCount = Math.max(0, student.runCount + delta);
                student.runCount = newCount;

                // Update the display
                const display = document.getElementById(`runCount-${studentId}`);
                if (display) {
                    display.textContent = newCount;
                }
            }
        }

        function updateStepStatus(studentId, stepIndex, newStatus) {
            const student = applicationData.students.find(s => s.id === studentId);
            if (student && stepIndex >= 0 && stepIndex < student.stepStatuses.length) {
                student.stepStatuses[stepIndex] = newStatus;

                // Update the visual indicator
                const stepDot = document.querySelector(`#expanded-${studentId} .step-dot:nth-child(${stepIndex + 1})`);
                if (stepDot) {
                    stepDot.className = `step-dot ${newStatus}`;
                    stepDot.title = `Step ${stepIndex + 1}: ${newStatus.toUpperCase()}`;
                }
            }
        }

        function updateRemarks(studentId, remarks) {
            const student = applicationData.students.find(s => s.id === studentId);
            if (student) {
                student.remarks = remarks;
            }
        }

        function handleFileUpload(studentId, files) {
            // Simulate file upload
            console.log(`Uploading ${files.length} files for student ${studentId}`);

            const student = applicationData.students.find(s => s.id === studentId);
            if (student) {
                student.sendFiles += files.length;

                // Refresh the file content
                switchFileTab(studentId, 'send');
            }
        }

        function saveChanges(studentId) {
            // Simulate saving changes
            console.log(`Saving changes for student ${studentId}`);

            // Show success message (you can implement a toast notification here)
            alert('Changes saved successfully!');
        }

        function updateStatistics(students = applicationData.students) {
            const stats = {
                total: students.length,
                processing: students.filter(s => s.status === 'processing').length,
                complete: students.filter(s => s.status === 'complete').length,
                failed: students.filter(s => s.status === 'failed').length
            };

            // Update the display
            const elements = {
                totalStudents: document.getElementById('totalStudents'),
                processingCount: document.getElementById('processingCount'),
                completedCount: document.getElementById('completedCount'),
                failedCount: document.getElementById('failedCount')
            };

            if (elements.totalStudents) elements.totalStudents.textContent = stats.total;
            if (elements.processingCount) elements.processingCount.textContent = stats.processing;
            if (elements.completedCount) elements.completedCount.textContent = stats.complete;
            if (elements.failedCount) elements.failedCount.textContent = stats.failed;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // Service Steps Modal Functions
        function showServiceSteps(serviceKey) {
            const modal = document.getElementById('serviceStepsModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');

            const serviceData = applicationData.serviceSteps[serviceKey];
            if (!serviceData) return;

            modalTitle.textContent = serviceData.title;

            let stepsHTML = '<div class="service-steps-container">';

            serviceData.steps.forEach(step => {
                stepsHTML += `
                    <div class="service-step-item">
                        <div class="service-step-number">${step.number}</div>
                        <div class="service-step-content">
                            <h4 class="service-step-title">${step.title}</h4>
                            <div class="service-step-details">${step.details}</div>
                            <div class="service-step-time"><strong>Processing Time:</strong> ${step.processingTime}</div>
                        </div>
                    </div>
                `;
            });

            stepsHTML += '</div>';

            if (serviceData.note) {
                stepsHTML += `<div class="service-note">${serviceData.note}</div>`;
            }

            stepsHTML += '<div class="service-end-transaction">END OF TRANSACTION</div>';

            modalBody.innerHTML = stepsHTML;
            modal.style.display = 'block';

            // Close modal when clicking outside
            modal.onclick = function (event) {
                if (event.target === modal) {
                    closeServiceStepsModal();
                }
            };
        }

        function closeServiceStepsModal() {
            const modal = document.getElementById('serviceStepsModal');
            modal.style.display = 'none';
        }

    </script>
</body>
</html>