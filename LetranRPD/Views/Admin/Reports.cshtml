@*
    This is a refactored version of Tracking.cshtml.

    KEY CHANGES:
    1.  FILTERING MOVED TO SERVER: The JavaScript `filterTable()` function has been REMOVED.
        Filtering is now handled by submitting a <form> to the server.
    2.  HTML FORM: The filter controls are wrapped in a <form method="get">. The inputs
        (search, status, dates) now have `name` attributes.
    3.  BUTTONS: The "Apply Filter" button is now a `type="submit"` for the form.
        The "Reset" button is now a simple link `<a>` that reloads the page without parameters.
    4.  JAVASCRIPT OPTIMIZED: The *remaining* JavaScript (for modals, bulk actions) has been
        kept, but optimized to use event delegation. This is more efficient.
    5.  CLEANER MODALS: Buttons for "Update" and "Archive" now use `data-*` attributes
        to pass all necessary info to the JavaScript, making it cleaner and more robust.
*@

@* These C# helper functions are great and remain unchanged. *@
@{
    Layout = "~/Views/Shared/_AdminNav.cshtml";
    var currentUser = Context.Session.GetObject<Account>("account");

    Func<int, string> GetStatusClass = (status) =>
    {
        switch (status)
        {
            case 0: return "pending";   // Not yet started
            case 1: return "active";    // In progress
            case 2: return "completed"; // Finished
            case 3: return "failed";    // Failed
            case 4: return "archived";  // Archived
            default: return "pending";
        }
    };

    Func<int, string> GetStatusText = (status) =>
    {
        switch (status)
        {
            case 0: return "Pending";
            case 1: return "Processing";
            case 2: return "Completed";
            case 3: return "Failed";
            case 4: return "Archived";
            default: return "Pending";
        }
    };

    Func<string, string> GetServiceCode = (serviceName) =>
    {
        switch (serviceName)
        {
            case "Originality Check": return "oc";
            case "Instrument Validation": return "iv";
            case "Language Editing": return "le";
            case "Data Analysis": return "da";
            case "Research Consultation": return "rc";
            case "Statistical Software Assistance": return "ssa";
            default: return "unknown";
        }
    };

    // --- REQUIRED FOR SERVER-SIDE FILTERING ---
    // We get the current filter values from the query string to set the
    // default state of the filter inputs. Your PageModel/Controller will
    // also use these values to filter the `Model`.
    var searchTerm = Context.Request.Query["SearchTerm"];
    var statusFilter = Context.Request.Query["Status"];
    var startDate = Context.Request.Query["StartDate"];
    var endDate = Context.Request.Query["EndDate"];
}
@using LetranRPD.Models
@model List<ServiceInformation>
@Html.AntiForgeryToken()

<div class="container-fluid tracking-page">

    <!-- Bulk Action Bar -->
    <div id="bulk-action-bar" class="bulk-action-bar" style="display: none;">
        <span id="selected-count">0</span> selected
        <button class="btn btn-sm btn-outline-danger" id="bulk-archive-btn">Archive Selected</button>
        <!-- Add other bulk actions here -->
    </div>

    <!-- Filter Controls - NOW A FORM -->
    <form method="get" class="filter-controls">
        <div class="search-bar">
            <input type="text" id="search-input" name="SearchTerm" class="form-control" placeholder="Search by name, service, or requester..." value="@searchTerm">
        </div>
        <div class="filter-options">
            <select id="status-filter" name="Status" class="form-control">
                <option value="">All Statuses</option>
                <option value="0" selected="@(statusFilter == "0")">Pending</option>
                <option value="1" selected="@(statusFilter == "1")">Processing</option>
                <option value="2" selected="@(statusFilter == "2")">Completed</option>
                <option value="3" selected="@(statusFilter == "3")">Failed</option>
                <option value="4" selected="@(statusFilter == "4")">Archived</option>
            </select>
            <input type="date" id="start-date" name="StartDate" class="form-control" value="@startDate">
            <input type="date" id="end-date" name="EndDate" class="form-control" value="@endDate">

            @* This is now a submit button for the form *@
            <button type="submit" id="apply-filter-btn" class="btn btn-primary">Apply Filter</button>

            @* This is now a simple link to clear the filters. 
               It assumes the current page is /Admin/Tracking. Update path if needed. *@
            <a href="/Admin/Tracking" id="reset-filter-btn" class="btn btn-outline-secondary">Reset</a>
        </div>
    </form>

    <!-- Services Table -->
    <div class="table-responsive">
        <table class="table table-hover" id="services-table">
            <thead>
                <tr>
                    <th><input type="checkbox" id="select-all"></th>
                    <th>Service ID</th>
                    <th>Service Name</th>
                    <th>Requester</th>
                    <th>Date Submitted</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @if (Model != null && Model.Any())
                {
                    foreach (var service in Model)
                    {
                        <tr class="data-row" data-date="@service.ServiceProgress.AppliedDate.ToString("yyyy-MM-dd")">
                            <td><input type="checkbox" class="row-checkbox" data-id="@service."></td>
                            <td>@GetServiceCode(service.ServiceType)-@service.ServiceId</td>
                            <td>@service.ServiceType</td>
                            <td>@service.Author</td>
                            <td>@service.ServiceProgress.AppliedDate.ToString("MMM dd, yyyy")</td>
                            <td>
                                @* <span class="status-badge @GetStatusClass(service.Stat)"> *@
                                @*     @GetStatusText(service.Status) *@
                                @* </span> *@
                            </td>
                            <td>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                        Actions
                                    </button>
                                    <ul class="dropdown-menu">
                                        @*
                                            OPTIMIZATION: Added data-* attributes to pass all info to JS.
                                            This avoids reading from table cells, which is brittle.
                                        *@
                                        <li>
                                            <button class="dropdown-item update-btn"
                                                    data-id="@service.ServiceId"
                                                    @* data-status="@service.Status" *@
                                                    data-remarks="@service.ServiceProgress.Remarks">
                                                Update Status
                                            </button>
                                        </li>
                                        <li>
                                            <button class="dropdown-item view-details-btn"
                                                    data-id="@service.ServiceId">
                                                View Details
                                            </button>
                                        </li>
                                        <li>
                                            <button class="dropdown-item archive-btn"
                                                    data-id="@service.ServiceId"
                                                    data-name="@(GetServiceCode(service.ServiceType))-@service.ServiceId">
                                                Archive
                                            </button>
                                        </li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr id="no-data-row">
                        <td colspan="7" class="text-center">No services found matching your criteria.</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Modals (HTML is unchanged) -->
<!-- Update Status Modal -->
<div id="updateModal" class="modal-backdrop" style="display: none;">
    <div class="modal-content">
        <span class="modal-close" data-modal-close>&times;</span>
        <h4>Update Service Status</h4>
        <form id="updateForm">
            <input type="hidden" id="update-service-id">
            <div class="form-group">
                <label for="update-status">Status</label>
                <select id="update-status" class="form-control">
                    <option value="0">Pending</option>
                    <option value="1">Processing</option>
                    <option value="2">Completed</option>
                    <option value="3">Failed</option>
                </select>
            </div>
            <div class="form-group">
                <label for="update-remarks">Remarks (Optional)</label>
                <textarea id="update-remarks" class="form-control" rows="3"></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Save Changes</button>
        </form>
    </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmationModal" class="modal-backdrop" style="display: none;">
    <div class="modal-content">
        <span class="modal-close" data-modal-close>&times;</span>
        <h4 id="confirmation-title">Confirm Action</h4>
        <p id="confirmation-message">Are you sure?</p>
        <div class="modal-actions">
            <button id="cancel-action-btn" class="btn btn-outline-secondary" data-modal-close>Cancel</button>
            <button id="confirm-action-btn" class="btn btn-danger">Confirm</button>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div id="toast-notification" class="toast-notification">
    <span id="toast-message"></span>
</div>


@*
    *****************************************************************
    REFACTORED JAVASCRIPT
    *****************************************************************

    - The `filterTable()` function has been completely REMOVED.
    - All code is wrapped in `DOMContentLoaded` to ensure the page is loaded.
    - Event listeners are now "delegated" from a single parent element.
      This is more efficient and works even if rows are added dynamically.
*@
<script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- CONSTANTS & STATE ---
        const table = document.getElementById('services-table');
        const selectAllCheckbox = document.getElementById('select-all');
        const rowCheckboxes = document.querySelectorAll('.row-checkbox');
        const bulkActionBar = document.getElementById('bulk-action-bar');
        const selectedCountEl = document.getElementById('selected-count');

        // Modals
        const updateModal = document.getElementById('updateModal');
        const confirmationModal = document.getElementById('confirmationModal');
        const updateForm = document.getElementById('updateForm');

        // Confirmation modal elements
        const confirmBtn = document.getElementById('confirm-action-btn');
        const confirmationMessage = document.getElementById('confirmation-message');

        // Store data for confirmation modal
        let confirmationData = {};

        // --- HELPER FUNCTIONS ---

        // Show/Hide Modals
        const showModal = (modal) => modal.style.display = 'flex';
        const hideModal = (modal) => modal.style.display = 'none';

        // Show Toast Notification
        const showToast = (message, isError = false) => {
            const toast = document.getElementById('toast-notification');
            const toastMessage = document.getElementById('toast-message');

            toastMessage.textContent = message;
            toast.className = 'toast-notification show';
            if (isError) {
                toast.classList.add('error');
            }

            setTimeout(() => {
                toast.className = toast.className.replace('show', '');
            }, 3000);
        };

        // Update Bulk Action Bar
        const updateBulkBar = () => {
            const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
            const count = checkedBoxes.length;

            if (count > 0) {
                selectedCountEl.textContent = count;
                bulkActionBar.style.display = 'flex';
            } else {
                bulkActionBar.style.display = 'none';
            }

            // Update "Select All" checkbox state
            selectAllCheckbox.checked = count > 0 && count === rowCheckboxes.length;
            selectAllCheckbox.indeterminate = count > 0 && count < rowCheckboxes.length;
        };

        // Get Anti-Forgery Token
        const getAFToken = () => {
            const tokenInput = document.getElementsByName('__RequestVerificationToken')[0];
            return tokenInput ? tokenInput.value : '';
        };

        // --- MAIN EVENT LISTENER (EVENT DELEGATION) ---
        // A single listener on the document handles clicks for modals, table buttons, etc.

        document.addEventListener('click', (e) => {

            // --- Modal Close Buttons ---
            if (e.target.dataset.modalClose !== undefined || e.target.classList.contains('modal-backdrop')) {
                e.target.closest('.modal-backdrop').style.display = 'none';
            }

            // --- Checkbox clicks (Select All & Row) ---
            if (e.target.id === 'select-all') {
                const isChecked = e.target.checked;
                rowCheckboxes.forEach(checkbox => {
                    checkbox.checked = isChecked;
                });
                updateBulkBar();
            }

            if (e.target.classList.contains('row-checkbox')) {
                updateBulkBar();
            }

            // --- Update Status Button Click ---
            if (e.target.classList.contains('update-btn')) {
                const btn = e.target;
                document.getElementById('update-service-id').value = btn.dataset.id;
                document.getElementById('update-status').value = btn.dataset.status;
                document.getElementById('update-remarks').value = btn.dataset.remarks || '';
                showModal(updateModal);
            }

            // --- Archive Button Click ---
            if (e.target.classList.contains('archive-btn')) {
                const btn = e.target;
                confirmationMessage.textContent = `Are you sure you want to archive service ${btn.dataset.name}?`;
                // Store data needed for the fetch call
                confirmationData = {
                    id: btn.dataset.id,
                    action: 'archive'
                };
                showModal(confirmationModal);
            }

            // --- Bulk Archive Button Click ---
            if (e.target.id === 'bulk-archive-btn') {
                const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
                const ids = Array.from(checkedBoxes).map(cb => cb.dataset.id);
                confirmationMessage.textContent = `Are you sure you want to archive ${ids.length} selected services?`;
                // Store data needed for the fetch call
                confirmationData = {
                    ids: ids, // Note: server must be able to handle an array of 'ids'
                    action: 'bulk-archive'
                };
                showModal(confirmationModal);
            }

            // --- Confirmation Modal "Confirm" Button ---
            if (e.target.id === 'confirm-action-btn') {
                handleConfirmation(confirmationData);
            }
        });


        // --- FORM SUBMISSION HANDLERS ---

        // Handle Update Status Form
        updateForm.addEventListener('submit', (e) => {
            e.preventDefault();

            const formData = new FormData();
            formData.append('Id', document.getElementById('update-service-id').value);
            formData.append('Status', document.getElementById('update-status').value);
            formData.append('Remarks', document.getElementById('update-remarks').value);
            formData.append('__RequestVerificationToken', getAFToken());

            fetch('/Admin/UpdateServiceStatus', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Status updated successfully.');
                    // Reloading is the simplest way to show changes.
                    // A more advanced way would be to update the row in-place.
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    showToast(data.message || 'Failed to update status.', true);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('An error occurred.', true);
            })
            .finally(() => {
                hideModal(updateModal);
            });
        });

        // Handle Confirmation Modal (Archive / Bulk Archive)
        const handleConfirmation = (data) => {
            let url = '';
            let body = new FormData();
            body.append('__RequestVerificationToken', getAFToken());

            if (data.action === 'archive' && data.id) {
                url = '/Admin/ArchiveService';
                body.append('Id', data.id);
            } else if (data.action === 'bulk-archive' && data.ids) {
                url = '/Admin/ArchiveBulk'; // <-- NOTE: This is a new endpoint you'd need to create
                // FormData doesn't nicely support arrays. Send as JSON.
                body = JSON.stringify({ Ids: data.ids });

                // We need to adjust fetch headers for JSON
                const token = getAFToken(); // Get token manually

                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': token // Send token in header
                    },
                    body: body
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        showToast('Services archived successfully.');
                        setTimeout(() => window.location.reload(), 1000);
                    } else {
                        showToast(result.message || 'Failed to archive services.', true);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('An error occurred.', true);
                })
                .finally(() => {
                    hideModal(confirmationModal);
                    confirmationData = {};
                });
                return; // Exit function since we used a different fetch
            } else {
                return; // No valid action
            }

            // Standard FormData fetch for single archive
            fetch(url, {
                method: 'POST',
                body: body
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showToast('Service archived successfully.');
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    showToast(result.message || 'Failed to archive service.', true);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('An error occurred.', true);
            })
            .finally(() => {
                hideModal(confirmationModal);
                confirmationData = {};
            });
        };

        // --- INITIALIZATION ---
        updateBulkBar();

    });
</script>

<style>
    /* Styles are copied from your original, but consolidated and cleaned up */

    /* Page layout */
    .tracking-page {
        padding: 20px;
        background-color: #f8f9fa;
    }

    /* Bulk Action Bar */
    .bulk-action-bar {
        display: none; /* Hidden by default */
        align-items: center;
        gap: 15px;
        padding: 10px 15px;
        background-color: #e6f7ff;
        border: 1px solid #b3e0ff;
        border-radius: 8px;
        margin-bottom: 20px;
    }

        .bulk-action-bar span {
            font-weight: 600;
        }

    /* Filter Controls */
    .filter-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 20px;
        padding: 15px;
        background-color: #ffffff;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

        .filter-controls .search-bar {
            flex-grow: 1;
            min-width: 250px;
        }

        .filter-controls .filter-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            flex-grow: 2;
        }

        .filter-controls .form-control,
        .filter-controls .btn {
            height: 38px;
        }

    /* Table */
    .table-responsive {
        background-color: #ffffff;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        overflow-x: auto;
    }

    .table {
        margin-bottom: 0;
    }

        .table thead th {
            background-color: #f8f9fa;
            border-top: none;
        }

        .table th, .table td {
            vertical-align: middle;
        }

    .table-hover tbody tr:hover {
        background-color: #f1f3f5;
    }

    /* Status Badges */
    .status-badge {
        display: inline-block;
        padding: 0.3em 0.6em;
        font-size: 0.85em;
        font-weight: 600;
        border-radius: 20px;
        color: #fff;
        text-transform: capitalize;
    }

        .status-badge.pending {
            background-color: #6c757d;
        }

        .status-badge.active {
            background-color: #007bff;
        }

        .status-badge.completed {
            background-color: #28a745;
        }

        .status-badge.failed {
            background-color: #dc3545;
        }

        .status-badge.archived {
            background-color: #343a40;
        }

    /* Modals */
    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1050;
    }

    .modal-content {
        background: #fff;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        width: 90%;
        max-width: 500px;
        position: relative;
    }

    .modal-close {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 24px;
        font-weight: bold;
        color: #888;
        cursor: pointer;
    }

        .modal-close:hover {
            color: #000;
        }

    .modal-content h4 {
        margin-top: 0;
        margin-bottom: 20px;
    }

    .modal-content .form-group {
        margin-bottom: 15px;
    }

    .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
    }

    /* Toast Notification */
    .toast-notification {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: #333;
        color: #fff;
        padding: 12px 20px;
        border-radius: 25px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        z-index: 1100;
        visibility: hidden;
        opacity: 0;
        transition: visibility 0s, opacity 0.3s ease-in-out;
    }

        .toast-notification.show {
            visibility: visible;
            opacity: 1;
        }

        .toast-notification.error {
            background-color: #dc3545;
        }
</style>