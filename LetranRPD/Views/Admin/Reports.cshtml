@{
    Layout = "~/Views/Shared/_AdminNav.cshtml";
}
<link href="/css/admin/dashboard.css" rel="stylesheet" type="text/css" />
<link rel="stylesheet" href="~/css/admin/Reports.css">

<div class="container">
    <div class="header">

        <h1>AUDIT LOG</h1>
    </div>

    <div class="search-bar">
        <input type="text" id="searchInput" placeholder="Search by Student Name, ID Number, or Service..." onkeyup="performSearch()">
        <button class="btn btn-primary" onclick="performSearch()">
            <span>🔍</span> Search
        </button>
        <button class="btn btn-secondary" onclick="clearSearch()">Clear</button>
    </div>

    <div class="controls">
        <div class="control-group">
            <label for="dateRange">Date Range</label>
            <select id="dateRange" onchange="handleDateRangeChange()">
                <option value="7d">Last 7 Days</option>
                <option value="1m">Last 1 Month</option>
                <option value="3m">Last 3 Months</option>
                <option value="6m">Last 6 Months</option>
                <option value="1y">Last 1 Year</option>
                <option value="custom">Custom</option>
            </select>
        </div>

        <div class="control-group" id="customDateGroup" style="display: none;">
            <label for="customStartDate">Start Date</label>
            <input type="date" id="customStartDate">
        </div>

        <div class="control-group" id="customEndDateGroup" style="display: none;">
            <label for="customEndDate">End Date</label>
            <input type="date" id="customEndDate">
        </div>

        <div class="control-group">
            <label for="section">Department</label>
            <select id="section" onchange="filterAuditLogs()">
                <option value="">All Department</option>
                <option value="Senior High School Department">Senior High School Department</option>
                <option value="College of Education, Liberal Arts, and Sciences">College of Education Liberal Arts and Sciences</option>
                <option value="College of Business Administration and Accountancy">College of Business Administration and Accountancy</option>
                <option value="College of Engineering and Information Technology">College of Engineering and Information Technology</option>
                <option value="College of Education">College of Education</option>
                <option value="Research and Publication Department">Research and Publication Department</option>
            </select>
        </div>

        <div class="control-group">
            <label for="eventType">Type of Service</label>
            <select id="eventType" onchange="filterAuditLogs()">
                <option value="">All Services</option>
                <option value="Originality Check">Originality Checking</option>
                <option value="Language Editing">Language Editing</option>
                <option value="Ethical Review">Ethical Review</option>
                <option value="Data Analysis">Data Analysis</option>
                <option value="Instrument Validation">Instrument Validation</option>
                <option value="Student Research Clearance">Student Research Clearance</option>
            </select>
        </div>

        <div class="control-group">
            <label for="resultType">Result</label>
            <select id="resultType" onchange="filterAuditLogs()">
                <option value="">All Results</option>
                <option value="Success">Success</option>
                <option value="Failed">Failed</option>
                <option value="Revision">Revision</option>
            </select>
        </div>

        <div class="control-group">
            <label for="attemptType">Attempts</label>
            <select id="attemptType" onchange="filterAuditLogs()">
                <option value="">All Attempts</option>
                <option value="1">1st Attempt</option>
                <option value="2">2nd Attempt</option>
                <option value="3">3rd Attempt</option>
                <option value="4+">4+ Attempts</option>
            </select>
        </div>

        <div class="button-group">
            <button class="btn btn-secondary" onclick="resetFilters()">Reset</button>
        </div>


    </div>

    <div class="table-wrapper">
        <div class="header-actions">
            <span class="selected-count">
                <span id="checkedCount">0</span> selected
            </span>
            <div class="action-buttons">
                <button class="btn btn-sm btn-secondary" onclick="selectAll()">Select All</button>
                <button class="btn btn-sm btn-secondary" onclick="deselectAll()">Deselect</button>
                <button class="btn btn-sm btn-warning" onclick="editSelected()">Edit</button>
                <button class="btn btn-sm btn-danger" onclick="deleteSelected()">Delete</button>
                <button class="btn btn-sm btn-primary" onclick="exportSelected()">Export</button>
            </div>
        </div>
    </div>


    <div class="table-container">
        <table id="auditTable">
            <thead>
                <tr>
                    <th>
                        <div class="checkbox-wrapper">
                            <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                        </div>
                    </th>
                    <th class="sortable" onclick="sortTable('Department')">Department</th>
                    <th class="sortable" onclick="sortTable('Service')">Service</th>
                    <th class="sortable" onclick="sortTable('result')">Result</th>
                    <th class="sortable" onclick="sortTable('Student')">Student Name</th>
                    <th class="sortable" onclick="sortTable('IDNo')">ID No.</th>
                    <th class="sortable" onclick="sortTable('attempts')">Run Count</th>
                    <th class="sortable" onclick="sortTable('submissionDate')">Date Applied</th>

                </tr>
            </thead>
            <tbody id="auditBody">
            </tbody>
        </table>
    </div>
    <div id="emptyState" class="empty-state" style="display: none;">
        <p>No audit logs found for the selected filters.</p>
    </div>
</div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Edit Audit Log</h2>
            <span class="close" onclick="closeEditModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="editForm">
                <input type="hidden" id="editId">

                <div class="form-group">
                    <label for="editDepartment">Department</label>
                    <select id="editDepartment" required>
                        <option value="Senior High School Department">Senior High School Department</option>
                        <option value="College of Education, Liberal Arts, and Sciences">College of Education Liberal Arts and Sciences</option>
                        <option value="College of Business Administration and Accountancy">College of Business Administration and Accountancy</option>
                        <option value="College of Engineering and Information Technology">College of Engineering and Information Technology</option>
                        <option value="College of Education">College of Education</option>
                        <option value="Research and Publication Department">Research and Publication Department</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="editService">Service</label>
                    <select id="editService" required>
                        <option value="Originality Check">Originality Checking</option>
                        <option value="Language Editing">Language Editing</option>
                        <option value="Ethical Review">Ethical Review</option>
                        <option value="Data Analysis">Data Analysis</option>
                        <option value="Instrument Validation">Instrument Validation</option>
                        <option value="Student Research Clearance">Student Research Clearance</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="editResult">Result</label>
                    <select id="editResult" required>
                        <option value="Success">Success</option>
                        <option value="Failed">Failed</option>
                        <option value="Revision">Revision</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="editStudent">Student Name</label>
                    <input type="text" id="editStudent" required>
                </div>

                <div class="form-group">
                    <label for="editIDNo">ID Number</label>
                    <input type="text" id="editIDNo" maxlength="7" pattern="[0-9]{7}" required>
                </div>

                <div class="form-group">
                    <label for="editAttempts">Attempts</label>
                    <input type="number" id="editAttempts" min="1" max="10" required>
                </div>

                <div class="form-group">
                    <label for="editSubmissionDate">Submission Date</label>
                    <input type="datetime-local" id="editSubmissionDate" required>
                </div>



                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>
<script>


               let allLogs = [];
        let filteredLogs = [];
        let selectedLogs = new Set();
        let currentSort = { column: 'appliedDate', direction: 'desc' };

        document.addEventListener('DOMContentLoaded', async () => {
            await fetchAuditLogs();
            filterAuditLogs(); // Render table after data loads
        });

        async function fetchAuditLogs() {
            try {
                const response = await fetch('/Admin/GetAuditLogs');
                const data = await response.json();

                // Convert date strings to Date objects
                allLogs = data.map((log, index) => ({
                    id: index,
                    Department: log.department || 'N/A',
                    Service: log.service || 'N/A',
                    ServiceName: log.service || 'N/A',
                    result: log.result || 'Pending',
                    Student: log.student || 'N/A',
                    IDNo: log.idNo || 'N/A',
                    attempts: log.attempts || 1,
                    submissionDate: log.appliedDate ? new Date(log.appliedDate) : null,
                    completionDate: log.completionDate ? new Date(log.completionDate) : new Date(log.submissionDate),
                    time: log.appliedDate ? new Date(log.appliedDate) : null
                }));

                filteredLogs = [...allLogs];
                renderTable();
            } catch (error) {
                console.error('Error fetching audit logs:', error);
            }
        }



            function handleDateRangeChange() {
                const dateRange = document.getElementById('dateRange').value;
                const customDateGroup = document.getElementById('customDateGroup');
                const customEndDateGroup = document.getElementById('customEndDateGroup');

                if (dateRange === 'custom') {
                    customDateGroup.style.display = 'flex';
                    customEndDateGroup.style.display = 'flex';
                } else {
                    customDateGroup.style.display = 'none';
                    customEndDateGroup.style.display = 'none';
                    filterAuditLogs();
                }
            }

            function getDateRangeFilter() {
                const dateRange = document.getElementById('dateRange').value;
                const now = new Date();
                let startDate = new Date(now);

                switch(dateRange) {
                    case '7d':
                        startDate.setDate(now.getDate() - 7);
                        break;
                    case '1m':
                        startDate.setMonth(now.getMonth() - 1);
                        break;
                    case '3m':
                        startDate.setMonth(now.getMonth() - 3);
                        break;
                    case '6m':
                        startDate.setMonth(now.getMonth() - 6);
                        break;
                    case '1y':
                        startDate.setFullYear(now.getFullYear() - 1);
                        break;
                    case 'custom':
                        const customStart = document.getElementById('customStartDate').value;
                        const customEnd = document.getElementById('customEndDate').value;
                        if (customStart && customEnd) {
                            return {
                                start: new Date(customStart),
                                end: new Date(customEnd)
                            };
                        }
                        return null;
                    default:
                        return null;
                }
                     if (!startDate || isNaN(startDate)) return null;

            return { start: startDate, end: now };

            }

            function filterAuditLogs() {
        const section = document.getElementById('section').value.trim();
        const eventType = document.getElementById('eventType').value.trim();
        const resultType = document.getElementById('resultType').value.trim();
        const attemptType = document.getElementById('attemptType').value.trim();
        const dateRange = getDateRangeFilter();

        filteredLogs = allLogs.filter(log => {
            let matches = true;

            // Normalize strings
            const dept = (log.Department || '').toLowerCase();
            const service = (log.Service || '').toLowerCase();
            const result = (log.result || '').toLowerCase();
            const student = (log.Student || '').toLowerCase();
            const idno = (log.IDNo || '').toLowerCase();

            // 🔍 Search filter
            if (searchTerm) {
                const s = searchTerm.toLowerCase();
                matches = matches && (
                    student.includes(s) ||
                    idno.includes(s) ||
                    service.includes(s) ||
                    dept.includes(s)
                );
            }

            // 🏛 Department filter
            if (section) {
                matches = matches && dept === section.toLowerCase();
            }

            // 🧾 Type of Service filter
            if (eventType) {
                const serviceMap = {
                    'Originality Check': 'originality check',
                        'Language Editing': 'language editing',
                        'Ethical Review': 'ethical review',
                        'Data Analysis': 'data analysis',
                        'Student Research Clearance': 'student research clearance'
                };
                const selectedService = serviceMap[eventType] || eventType.toLowerCase();
                matches = matches && service.includes(selectedService);
            }

            // 🧩 Result filter
            if (resultType) {
                matches = matches && result === resultType.toLowerCase();
            }

            // 🔁 Attempt filter
            if (attemptType) {
                if (attemptType === '4+') {
                    matches = matches && log.attempts >= 4;
                } else {
                    matches = matches && log.attempts === parseInt(attemptType);
                }
            }


                // 📅 Date range filter (use Applied Date)
        if (dateRange && log.submissionDate) {
            const applied = new Date(log.submissionDate);
            if (isNaN(applied)) return false;
            matches = matches && applied >= dateRange.start && applied <= dateRange.end;
        }



            return matches;
        });

        console.log('Filtered results:', filteredLogs.length, 'logs');
        sortTable(currentSort.column, false);
        renderTable();
    }


               function sortTable(column, toggle = true) {
                if (toggle && currentSort.column === column) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.column = column;
                    currentSort.direction = 'desc';
                }

                filteredLogs.sort((a, b) => {
                    let aVal = a[column];
                    let bVal = b[column];

                    if (column === 'time' || column === 'submissionDate' || column === 'completionDate') {
                        aVal = a[column].getTime();
                        bVal = b[column].getTime();
                    }

                    if (typeof aVal === 'string') {
                        aVal = aVal.toLowerCase();
                        bVal = bVal.toLowerCase();
                    }

                    if (currentSort.direction === 'asc') {
                        return aVal > bVal ? 1 : -1;
                    } else {
                        return aVal < bVal ? 1 : -1;
                    }
                });

                updateSortHeaders();
                renderTable();
            }

            function updateSortHeaders() {
                document.querySelectorAll('th.sortable').forEach(th => {
                    th.classList.remove('sorted-asc', 'sorted-desc');
                });

                const headers = document.querySelectorAll('th.sortable');
                headers.forEach(th => {
                    if (th.textContent.toLowerCase().includes(currentSort.column.toLowerCase())) {
                        th.classList.add(currentSort.direction === 'asc' ? 'sorted-asc' : 'sorted-desc');
                    }
                });
            }

                   function renderTable() {
                const tbody = document.getElementById('auditBody');
                const emptyState = document.getElementById('emptyState');

                if (filteredLogs.length === 0) {
                    tbody.innerHTML = '';
                    emptyState.style.display = 'block';
                    return;
                }

                emptyState.style.display = 'none';
                tbody.innerHTML = filteredLogs.map(log => {
                    let resultBadgeClass = 'success-badge';
                    if (log.result === 'Revision') resultBadgeClass = 'warn-badge';
                    if (log.result === 'Failed') resultBadgeClass = 'error-badge';

                    // Highlight search terms
                    let studentName = log.Student;
                    let idNo = log.IDNo;
                    let serviceName = log.ServiceName;

                    if (searchTerm) {
                        const regex = new RegExp(`(${searchTerm})`, 'gi');
                        studentName = studentName.replace(regex, '<mark>$1</mark>');
                        idNo = idNo.replace(regex, '<mark>$1</mark>');
                        serviceName = serviceName.replace(regex, '<mark>$1</mark>');
                    }

                    return `
                    <tr class="${selectedLogs.has(log.id) ? 'selected' : ''}" data-id="${log.id}">
                        <td>
                            <div class="checkbox-wrapper">
                                <input type="checkbox"
                                    ${selectedLogs.has(log.id) ? 'checked' : ''}
                                    onchange="toggleRowSelection(${log.id})">
                            </div>
                        </td>
                        <td><span class="area-badge">${log.Department}</span></td>
                        <td><span class="event-text">${serviceName}</span></td>
                        <td><span class="${resultBadgeClass}">${log.result}</span></td>
                        <td>${studentName}</td>
                        <td><span class="ip-text">${idNo}</span></td>
                        <td><span class="attempts-badge">${log.attempts}</span></td>
                        <td><span class="time-text">${formatDate(log.submissionDate)}</span></td>

                    </tr>
                `}).join('');

                updateSortHeaders();
                updateCheckedCount();
            }

            function toggleRowSelection(logId) {
                if (selectedLogs.has(logId)) {
                    selectedLogs.delete(logId);
                } else {
                    selectedLogs.add(logId);
                }
                renderTable();
            }

            function toggleSelectAll() {
                const checkbox = document.getElementById('selectAllCheckbox');

                if (checkbox.checked) {
                    filteredLogs.forEach(log => selectedLogs.add(log.id));
                } else {
                    filteredLogs.forEach(log => selectedLogs.delete(log.id));
                }
                renderTable();
            }

            function selectAll() {
                filteredLogs.forEach(log => selectedLogs.add(log.id));
                document.getElementById('selectAllCheckbox').checked = true;
                renderTable();
            }

            function deselectAll() {
                selectedLogs.clear();
                document.getElementById('selectAllCheckbox').checked = false;
                renderTable();
            }

            function updateCheckedCount() {
                document.getElementById('checkedCount').textContent = selectedLogs.size;
            }

               function editSelected() {
                if (selectedLogs.size === 0) {
                    alert('Please select at least one row to edit');
                    return;
                }

                if (selectedLogs.size > 1) {
                    alert('Please select only one row to edit');
                    return;
                }

                const logId = Array.from(selectedLogs)[0];
                const log = allLogs.find(l => l.id === logId);

                if (!log) return;

                // Format dates for datetime-local input
                const formatDateForInput = (date) => {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    return `${year}-${month}-${day}T${hours}:${minutes}`;
                };

                // Populate the modal with current values
                document.getElementById('editId').value = log.id;
                document.getElementById('editDepartment').value = log.Department;
                document.getElementById('editService').value = log.Service;
                document.getElementById('editResult').value = log.result;
                document.getElementById('editStudent').value = log.Student;
                document.getElementById('editIDNo').value = log.IDNo;
                document.getElementById('editAttempts').value = log.attempts;
                document.getElementById('editSubmissionDate').value = formatDateForInput(log.submissionDate);


                // Show modal
                document.getElementById('editModal').style.display = 'flex';
            }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        // Handle form submission
            document.addEventListener('DOMContentLoaded', function() {
                document.getElementById('editForm').addEventListener('submit', function(e) {
                    e.preventDefault();

                    const id = parseInt(document.getElementById('editId').value);
                    const serviceCode = document.getElementById('editService').value;
                    const serviceNames = {
                        'Oc': 'Originality Checking',
                        'Le': 'Language Editing',
                        'Er': 'Ethical Review',
                        'Da': 'Data Analysis',
                        'SRC': 'Student Research Clearance'
                    };

                    const submissionDate = new Date(document.getElementById('editSubmissionDate').value);





                    // Find and update the log
                    const logIndex = allLogs.findIndex(l => l.id === id);
                    if (logIndex !== -1) {
                        allLogs[logIndex] = {
                            ...allLogs[logIndex],
                            Department: document.getElementById('editDepartment').value,
                            Service: serviceCode,
                            ServiceName: serviceNames[serviceCode],
                            result: document.getElementById('editResult').value,
                            Student: document.getElementById('editStudent').value,
                            IDNo: document.getElementById('editIDNo').value,
                            attempts: parseInt(document.getElementById('editAttempts').value),
                            submissionDate: submissionDate,

                            time: submissionDate
                        };

                        // Call your C# API here to update in database
                        // fetch('/api/audit-logs/update', { method: 'PUT', body: JSON.stringify(allLogs[logIndex]) })

                        filterAuditLogs();
                        closeEditModal();
                        deselectAll();
                        alert('Log updated successfully!');
                    }
                });
            });
            function deleteSelected() {
                if (selectedLogs.size === 0) {
                    alert('Please select at least one row to delete');
                    return;
                }

                if (confirm(`Are you sure you want to delete ${selectedLogs.size} row(s)?`)) {
                    const idsToDelete = Array.from(selectedLogs);
                    console.log('Deleting IDs:', idsToDelete);

                    // Call your C# API here
                    // Example: fetch('/api/audit-logs/delete', { method: 'POST', body: JSON.stringify(idsToDelete) })

                    selectedLogs.forEach(id => {
                        allLogs = allLogs.filter(log => log.id !== id);
                    });
                    selectedLogs.clear();
                    filterAuditLogs();
                    alert('Rows deleted successfully');
                }
            }

                   function exportSelected() {
                if (selectedLogs.size === 0) {
                    alert('Please select at least one row to export');
                    return;
                }

                const selectedData = filteredLogs.filter(log => selectedLogs.has(log.id));

                // Use the convertToCSV function which has the correct headers
                const csv = convertToCSV(selectedData);

                // Download CSV first, then user can import to Google Sheets
                downloadCSV(csv);

                // Alert user with instructions
                setTimeout(() => {
                    if (confirm('CSV downloaded! Would you like to open Google Sheets to import it?\n\nClick OK to open Google Sheets, then:\n1. Click File > Import\n2. Upload the downloaded CSV file')) {
                        const googleSheetsUrl = `https://docs.google.com/spreadsheets/create?usp=sheets_web#gid=0`;
                        window.open(googleSheetsUrl, '_blank');
                    }
                }, 500);
            }

                function convertToCSV(data) {
                const headers = ['Department', 'Service', 'Result', 'Student Name', 'ID No.', 'Attempts', 'Submission Date', 'Completion Date'];
                const rows = data.map(log => [
                    log.Department,
                    log.ServiceName,
                    log.result,
                    log.Student,
                    log.IDNo,
                    log.attempts,
                    formatDate(log.submissionDate),
                    formatDate(log.completionDate)
                ]);

                const csvContent = [
                    headers.join(','),
                    ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
                ].join('\n');

                return csvContent;
            }

            function downloadCSV(csv) {
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `audit-log-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
            }

            function formatDate(date) {
                const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
                return date.toLocaleDateString('en-US', options);
            }

                function resetFilters() {
                document.getElementById('dateRange').value = '7d';
                document.getElementById('section').value = '';
                document.getElementById('eventType').value = '';
                document.getElementById('resultType').value = '';
                document.getElementById('attemptType').value = '';
                document.getElementById('customStartDate').value = '';
                document.getElementById('customEndDate').value = '';
                document.getElementById('customDateGroup').style.display = 'none';
                document.getElementById('customEndDateGroup').style.display = 'none';

                filteredLogs = [...allLogs];
                currentSort = { column: 'time', direction: 'desc' };
                deselectAll();
                sortTable(currentSort.column, false);
                renderTable();
            }

                let searchTerm = '';

            function performSearch() {
                searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
                console.log('Searching for:', searchTerm);
                filterAuditLogs();
            }

            function clearSearch() {
                document.getElementById('searchInput').value = '';
                searchTerm = '';
                filterAuditLogs();
            }
</script>

