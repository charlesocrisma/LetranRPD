@{
    ViewData["Title"] = "Account";
}
@{
    ViewBag.Title = "Account";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var currentUser = Context.Session.GetObject<Account>("account") ?? null;
    if (currentUser == null)
    {
        Context.Response.Redirect("Home");
    }

}

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
<title>Account</title>
<link rel="stylesheet" href="~/css/Account.css" asp-append-version="true" />

<div class="container">

    <header class="header">
        <div class="header-content">
            <h1>Account Settings</h1>
        </div>
    </header>


    <main class="main-content">
        <div class="settings-container">


            <nav class="settings-nav">
                <ul class="nav-list">

                    <li class="nav-item active">
                        <a href="#profile" class="nav-link">
                            <i class="fa-solid fa-address-card"></i>

                            <span style="padding-left:10px;">Account</span>
                        </a>
                    </li>

                    <li class="nav-item">

                        <a href="#security" class="nav-link">
                            <i class="fa-solid fa-lock"></i>
                            <span style="padding-left:10px;">Security</span>
                        </a>

                    </li>
                </ul>
            </nav>



            <div class="settings-content">
                <section id="profile" class="settings-section active">

                    <h2>Profile Information</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="firstName">First Name</label>

                            <input type="text" id="firstName" Value="@currentUser.FirstName" class="form-input">
                        </div>
                        <div class="form-group">

                            <label for="lastName">Last Name</label>
                            <input type="text" id="lastName" value="@currentUser.LastName" class="form-input">
                        </div>
                        <div class="form-group">

                            <label for="studentId">Student ID</label>
                            <input type="text" id="studentId" value="@currentUser.StudentNumber" class="form-input" readonly>
                        </div>
                        <div class="form-group">

                            <label for="department">Department</label>
                            <input type="text" id="studentId" value="@currentUser.Level" class="form-input" readonly>
                        </div>



                        <div class="form-group">
                            <label for="email">Email Address</label>
                            <input type="email" id="email" value="@currentUser.Email" class="form-input">
                        </div>


                        <button class="save-btn">Save Changes</button>
                </section>


                <section id="security" class="settings-section">
                    <h2>Security</h2>

                    <form id="securityForm">
                        <div class="security-item">
                            <h3>Change Password</h3>
                            <div class="form-group">
                                <label for="currentPassword">Current Password</label>
                                <input type="password" id="currentPassword" name="currentPassword" class="form-input">
                            </div>
                            <div class="form-group">
                                <label for="newPassword">New Password</label>
                                <input type="password" id="newPassword" name="newPassword" class="form-input">
                            </div>
                            <div class="form-group">
                                <label for="confirmPassword">Confirm New Password</label>
                                <input type="password" id="confirmPassword" name="confirmPassword" class="form-input">
                            </div>
                            <button type="submit" class="secondary-btn">Update Password</button>

                            <div id="securityMessage" style="margin-top: 15px; font-weight: bold;"></div>
                        </div>
                    </form>
                </section>


            </div>
        </div>
    </main>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- This code for tab navigation is the same ---
        const navLinks = document.querySelectorAll('.nav-link');
        const sections = document.querySelectorAll('.settings-section');

        navLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                navLinks.forEach(l => l.parentElement.classList.remove('active'));
                sections.forEach(s => s.classList.remove('active'));
                this.parentElement.classList.add('active');
                const targetId = this.getAttribute('href').substring(1);
                const targetSection = document.getElementById(targetId);
                if (targetSection) {
                    targetSection.classList.add('active');
                }
            });
        });

        // --- NEW: Handle the security form submission ---
        const securityForm = document.getElementById('securityForm');
        const securityMessage = document.getElementById('securityMessage');

        if (securityForm) {
            securityForm.addEventListener('submit', function(e) {
                e.preventDefault(); // Stop the form from submitting normally

                const formData = new FormData(this);
                const button = this.querySelector('.secondary-btn');
                const originalButtonText = button.textContent;

                // Show loading state
                button.textContent = 'Updating...';
                button.disabled = true;
                securityMessage.textContent = '';
                securityMessage.style.color = ''; // Reset color

                // Send the data to the controller
                fetch('@Url.Action("ChangePassword", "User")', {
                    method: 'POST',
                    body: new URLSearchParams(formData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // --- Success ---
                        securityMessage.textContent = data.message;
                        securityMessage.style.color = '#28a745'; // Green
                        // Clear the password fields
                        this.reset();
                    } else {
                        // --- Error from controller ---
                        securityMessage.textContent = data.message;
                        securityMessage.style.color = '#dc3545'; // Red
                    }
                })
                .catch(error => {
                    // --- Network or other error ---
                    console.error('Error:', error);
                    securityMessage.textContent = 'An unexpected error occurred. Please try again.';
                    securityMessage.style.color = '#dc3545'; // Red
                })
                .finally(() => {
                    // --- Reset button ---
                    button.textContent = originalButtonText;
                    button.disabled = false;
                });
            });
        }
    });
</script>